---
title: "NYC Neighborhood Income Analysis and Visualization"
author: "Shailen Sharma"
output:
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
  pdf_document:
    toc: yes
    number_sections: yes
    toc_depth: 3
urlcolor: blue
---

```{r setup, include=FALSE}
# set options for the R markdown document
knitr::opts_chunk$set(echo = TRUE,      ## show or suppress the code
                      include = TRUE ,      ## show or suppress the output
                      message = FALSE,      ## omit messages generated by code
                      warning = FALSE,      ## omit warnings generated by code
                      comment = NA,         ## removes the ## from in front of outputs
                      fig.align = "center", ## centers all figures
                      fig.height = 5,     ## set the default height
                      fig.weight = 5      ## set the default width
)

# this is a good place to include the library calls for the packages you use


```

```{r}
# data manipulation and ggplot2
library(tidyverse)
library(readxl)
# data visualizations
library(ggplot2)
#need this to use python codes to better match column names
library(reticulate)
# String manipulation and matching
library(fuzzyjoin)
# For string distance metrics
library(stringdist)
#used for interactive map
library(tmap)
#diagnostic plots
library(ggfortify)

```

```{r}
#Packages needed to read maps
library(installr)
# interactive maps
library(leaflet)
# For working with Google Maps
library(ggmap)
library(dplyr)
# access geographic boundaries
library(tigris)
library(sp)
library(sf)
library(httr)
# For handling spatial data
library(maptools)
library(broom)


```

# Introduction

This report is going to compare the different income rates of each of the five boroughs in New York City. 
There will be a focus on neighborhood income visualization within each borough. The viewer will see that there
are significant income gaps among many neighborhoods. There will be a focus on types of industries in each 
borough and whether these industries have a positive correlation on income. The industries will includes: 
management/business/arts/science, sales, production, and construction.
The main data set was taken from American Community Survey (ACS) Data Tables from NYC Planning 
(https://www.nyc.gov/site/planning/planning-level/nyc-population/american-community-survey.page.page).
The data set is an excel sheet that tracks a 5 year survey of economic data by each neighborhood in NYC. 
The data set will include information on income, industries, neighborhoods, and population. 
The second data set is taken from RPubs (https://rpubs.com/jhofman/nycmaps). It contains the spacial points
of each NYC neighborhood on a map along with the name and borough. 
The first visualization is a bar graph of each of the neighborhoods in the ACS survey colored by borough. 
This gives a visualization of the total income earned by neighborhood displayed by the borough color. 
The second visualization is a map of New York City colored by borough. This is done to give a visual
representation of where each borough is located on a map. 
The third visualization is an interactive map of each neighborhood. It displays the neighborhood income
by shades a blue. A limitation of this map is that when matching the neighborhood columns in the ASC survey 
and the map sf file, not all of the neighborhoods were available. The jw method was used in stringdistmatrix function
to match neighborhoods with similar spelling. This greatly increased the number of neighborhoods
that were able to be matched in each data frame without having many incorrect matches. For the data that is
available the map is excellent for viewing the income trends for the boroughs with the most neighborhood data available.
The fourth visualization is a box plot of income by borough. This visualization greater shows what the bar graph and map
could next and the more specific difference between the income of each borough. 
The last visualization is a regression plot separated by borough. The regression plot was used to look for a visual
correlation between types of industry and a greater income increase across all boroughs. The visualization show that 
of all the industries, Management, business, science, and arts, were able to have the greatest positive effect on
income all across all five boroughs. A regression model of the income and management/business/science/arts was taken with out separating the boroughs. There was some skewing on the left tail end, but the plot still showed a linear tread between income and the industry. A diagnostic test was ran to see how well the data was fitted. It was mostly normal.
Finally, a r correlation test is performed and finds correlation between this industry and income of 0.6124365.
This was the highest correlation compared to the other three industries. 



# Data exploration and visualization

The data frame is taken from the Department of NYC City Planning's website. It contains the 5 year average of various demographics data categorized by neighborhood in NYC. Some of the data includes population by neighborhood, income, industry, unemployment population, poverty population, etc. The visual representation of the data will include the neighborhood column and income column. The name of the income column will be change since it is not written in plain english. There are neighborhood entries that do not include income. Those neighborhoods will be filtered out. 

```{r}
neighborhoods <- read_excel("../Your_Path_Here/nyc.xlsx")
neighborhoods
```

```{r}
nyc <- neighborhoods %>%
  rename(Income = MdNFIncE, neighborhood = GeogName)
```

```{r}
nyc_income <- nyc %>%
  select(neighborhood, Borough, GeoID, Income) %>%
filter(!is.na(Income))
nyc_income
```

#Bar Graph Description
The data from the bar graph all comes from the New York City ACS survey. In this data frame there are 204
rows of available income and neighborhood data. Due to the construction of the bar graph, the neighborhood
labels could disrupt the visualizations. The neighborhoods were categorized by buroughs instead. On can see from
this bar graph that in general the higher income neighborhoods are located in Manhattan and the lower income 
neighborhoods are in the Bronx. 

```{r}

ggplot(nyc_income, aes(x = reorder(neighborhood, -Income) , y = Income, fill = Borough)) + 
  geom_col(width =  1.2) + theme(axis.text.x = element_blank()) + labs(x = "Neighborhood")

```


#Boxplot Buroughs 

The box is being used better show income trends be each burough that the bar graph is not able to do.  This plot  gives a more affirmative display of the medians, quartiles, and anomalies of each borough. From its medians the boroughs ranked from high to low income are Manhattan, Queens, Staten Island, Brooklyn, and the Bronx. A few things to notice are that 
Brooklyn's 3rd quartile has neighborhoods with much higher income than Queens and State Island. Queens
has an anomaly of a neighborhood with the highest income of all of New York City. 

```{r}
ggplot(nyc_income, aes(x = Borough, y = Income, fill = Borough)) +
  geom_boxplot() +  labs(title = "Income Boxplot by Borough")
```


# Visualization and interpretation of the results


```{r}
file_path <- "~/Your_Path_Here/nycneighborhoods.geojson"
nyc_neighborhoods <- st_read(file_path, quiet = TRUE)
```

```{r}
nyc_neighborhoods
```




```{r}
#This series of variables, data frame and for loop will be used to try to maximize the matches
#of neighborhood names in each data set
#Two variables are being created that contain each column of neighborhood names from each data frame
gps_neighborhood_names <- nyc_neighborhoods$neighborhood
income_neighbood_names <- nyc_income$neighborhood

#stringdistmatrix computes the distance between strings according row a and
#column b and produces a matrix with numerical values.
# this will associate the char vector in each data frame with its most
#likely match based on its shared numeric value and stores the values
# in jaccard_neighborhodos

jaccard_neighborhoods <- stringdistmatrix(gps_neighborhood_names, 
              income_neighbood_names,  method = "jw")

# a new data from is created with two columns empty character vectors 
#stringasfactors prevents character vectors from being stored as factors. 
matches <- data.frame(neighborhood_1 = character(), 
                      neighborhood_2 = character(), stringsAsFactors = FALSE)

#the outer for loop will iterate over the jaccard values in n number of
#neighborhood rows. The inner for loop does the same for n number of columns
#if the numeric value of each row and column is less than 0.4 then the
# neighborhood from the neighborhoods and income data set are matched
#in a new data frame via the rbind function
for (values in 1:nrow(jaccard_neighborhoods)) {
  for (matching_values in 1:ncol(jaccard_neighborhoods)) {
    if (jaccard_neighborhoods[values, 
                              matching_values] < 0.2) {  
      matches <- rbind(matches, data.frame(
        neighborhood_1 = gps_neighborhood_names[values],
        neighborhood_2 = income_neighbood_names[matching_values]))
    }
  }
}

matches

```


```{r}
#the neighborhood_1 column needs to be renamed to neighborhood to use the 
#left_join to join by the same column
matches_renamed <- matches %>%
  rename(neighborhood = neighborhood_1)

```



```{r}
# The new match data frame is joined with the nyc_income data frame.
# This is done to preserve all of the columns while having the income and mathced
#neighborhoods in the same data frame
merged_data <- left_join(nyc_income, matches_renamed, by = "neighborhood")

#The new data frame is matched with the sf data frame to be able to display the 
# income data that had a successful match. The other neighborhoods and geometry
#columns are preserved to maintain the entire map even with the missing income data. 
merged_data_final <- left_join(nyc_neighborhoods, merged_data, by = "neighborhood")


```

#Map of New York City Boroughs.
This map was imported from RPubs. It contains 310 rows of neighborhood, borough, and geometric point information.
This map was included to give the viewer a visual representation of the boroughs and can be compared to the 
neighborhood income map. 

```{r}
#since the map has been read via st, it is not a shapefile and therefore a data 
#frame.
#Since the coordinates are stored in the geometry column aes is not needed
#and therefore geom_sf is used to form the map
ggplot() + 
  geom_sf(data=nyc_neighborhoods, aes(fill = borough)) +
  theme_minimal()
```

#Neighborhood Income Map
The New York City ACS data frame has 204 rows that contain the income, neighborhood and borough. The RPubs map
sf object contains 310 rows for for the spacial points, neighborhood, and borough. Just based off of this 
there were already going to be missing data points on the map. Additionally, simply joining the data frames only 
yielded 78 matches for neighborhoods. The intent of this map is the display income on the already designed map with 
neighborhood names. To maximize the neighborhood matches in each data frame stringdistmatrix was used to measure the 
distance between each char vector. Next the jw method was used to find a numeric value for each char vector match to add to the new data frame that contained the matched neighborhoods.The jw method was found to be the most effective method. A for loop and new data frame was created and each neighborhood match was entered into the new data frame called "matches". These were then joined with the income and neighborhood data frame to have much more neighborhood data displayed. When you hover the mouse over each grey neighborhood, the neighborhood is displayed. For the blue shaded neighborhoods the income is displayed as well. Each neighborhood with the available income data will be label by the borough of which it belongs to. For the boroughs with the majority of income data available this map gives a greater insight to the specific income data of each neighborhood much greater than what the bar graph was able to do. 


```{r}
#st_as_sf os used to convert the data frame in to a sf object
merged_data_tm <- st_as_sf(merged_data_final)

tmap_mode("view")

tm_shape(merged_data_tm) +
  tm_polygons(c("Income"), Name = "neighborhood", palette = "Blues") +
  tm_text("Borough", size = 0.5)
  
```



# Modeling/Analysis
These variables are going to be used for the regression modeling and diagnostic testing.
Name changes are needed because the column names in the ACS file are not written in
plain English. Not all of the columns were used in the testing. 

```{r}
rename_pop_and_income <- neighborhoods %>%
  rename(Population = Pop16plE, Income = MdEWrkE, Neighborhood = GeogName, GovWorker = GvtWrkrE, 
         PovertyPop = PopPvU1E, Unemployed = UEmE, PrivateWage = PrvWSWrkrE,
         Manufacturing = MnfctrngE, Finance = FIREE, MenIncome = MdEMFTWrkM, 
         OcupConstruction = NRCnstMntE, OcupBus = MgBSciArtE, OcupProduction = PrdTrnsMME, 
         SelfEmploy = SlfEmNIncE,  OcupSales = SalesOffE, Poverty = FamBwPvE, PrivateWorker = CvEm16pl4E,
         TravelTimetoWork = MnTrvTmE)
```

```{r}
#The population has frames for all rows where income has NA.
# Income is filtered for NA to remove all of these rows. 
pop_income_frame <- rename_pop_and_income %>%
  select(Neighborhood, Borough,Income, Population,PovertyPop, PrivateWage, GovWorker, 
         Manufacturing, Unemployed, Poverty,PrivateWorker, TravelTimetoWork, Finance, SelfEmploy, OcupBus, OcupProduction, OcupSales, OcupConstruction, MenIncome,  GeoID) %>%
filter(!is.na(Income))

```


# Regression Plots
The following visualizations are four regression plots separated by borough. The purpose of this was to 
observe the regression line between income and types of occupation. For Construction and production, as 
these types of labor expanded the income decreased for most of the borough. With the exception of Manhattan, 
and a slight positive effect for the Bronx and Staten Island, Sales did not have a net overall positive regression
line across all of the boroughs. Only  the industries of management, business, arts, and sciences, had a positive
effect on the regression line for income in every borough. 


```{r}
ggplot(pop_income_frame, aes(x = OcupBus, y = Income, fill = Borough)) +
  geom_point() + geom_smooth(method = "lm", col = "blue") + facet_wrap(facets = vars(Borough))
```

```{r}
ggplot(pop_income_frame, aes(x = OcupConstruction, y = Income, fill = Borough)) + 
  labs(x= "Construction") +
  geom_point() + geom_smooth(method = "lm", col = "blue") + facet_wrap(facets = vars(Borough)) 

```


```{r}
ggplot(pop_income_frame, aes(x = OcupSales, y = Income, fill = Borough)) + labs(x= "Sales") +
  geom_point() + geom_smooth(method = "lm", col = "blue") + facet_wrap(facets = vars(Borough))
```

```{r}
ggplot(pop_income_frame, aes(x = OcupProduction, y = Income, fill = Borough)) +  
  labs(x= "Production") +
  geom_point() + geom_smooth(method = "lm", col = "blue") + facet_wrap(facets = vars(Borough))
```



#Regression Plot for the Whole City

The plot shows some left skewing with a upward trend on the y axis for income as the industries of management, business,
arts, and sciences are increased. 

```{r}
ggplot(pop_income_frame, aes(x = OcupBus, y = Income)) +
  geom_point() + geom_smooth(method = "lm", col = "blue") + 
  labs(x = " Management, Business, Arts, & Science")
```


#Correlation Tests

Correlation tests were ran to nurmerically evaluate what was seen in the regression models. Income appeared
to be correlated by 0.6124365 an increase in business, arts, and sciences. Construction had a negative correlation,
which is most likely affected by the strong negative correlations in Manhattan and Brooklyn. Sales had a 
positive correlation of 0.1365706, which was affect by the strong positive associate in Manhattan and small positive 
associations in the Bronx and Staten Island. Last, production had a negative correlation with income of -0.3599047.
This was greatly influneced by the strong negative regression in Manhattan and Brooklyn. 


```{r}
business_correlation <- cor.test(rename_pop_and_income$Income, rename_pop_and_income$OcupBus)
business_correlation
```

```{r}
construction_correlation <-cor.test(rename_pop_and_income$Income, rename_pop_and_income$OcupConstruction)
construction_correlation
```

```{r}
sales_correlation <-cor.test(rename_pop_and_income$Income, rename_pop_and_income$OcupSales)
sales_correlation
```

```{r}
production_correlation <-cor.test(rename_pop_and_income$Income, rename_pop_and_income$OcupProduction)
production_correlation
```


#Diagnostic Test

The Residuals vs Fitted test shows a mostly even scatter across the zero point with some deviation from zero as the mean 
exceeds 11.25. 
The Q-Q Plot shows a mostly fitted plot. On the tail ends there are some deviations with some more extreme
deviations on the left tail. 
The standard residuals fall between  0.5 and 1 on a mostly linear plot There is some left skewing with a higher
standard residuals on the lower end of the fitted values.
In the Residuals vs Leverage plot the  residuals are scattered around the zero point at low leverage. The are some
anomalies that skew the plot fit slightly negative in the right tail end of the model.



```{r}
diagnostic_bus <- lm(data = rename_pop_and_income, log(Income) ~ OcupBus)
autoplot(diagnostic_bus)


```



# Conclusions and recommendations

The regression models show that management, business, science, and arts had the greatest positive impact on income
in each borough. Expanding this industry could have a positive growth income, while expanding some of the other
industries to specific boroughs only could have a similar positive impact. However, there seemed to be a stronger regression model and fitted plot for the management, business, science, and arts industry, which indicates that this may be a reliable industry to depending if there is an interest to increase economic growth in each borough.  The data available from the ACS survey provided clear visual insights to the income of each borough. The merge between the map data and the ACS data was helpful for showing a better income and neighborhood visualization that the bar graph could not. However, due to some of the different spelling of each neighborhood; a better method for comparing string distance will be needed to increase ability of the map to represent the data. Additionally, one of the limitations is how neighborhoods are categorized in New York City. For example, the. ASC survey has a total of 262 neighborhoods with income data available for 204 neighborhoods. The New York City map data frame categorizes the city into 310 neighborhoods. This will still lead to missing data on the map. In the future, when more time is available, it may be better to redraw the map boarders or find a better map that can better reflect the data in the ACS survey. It may be also possible to individually try to match any missing neighborhood columns since the data frames are not too large. 

